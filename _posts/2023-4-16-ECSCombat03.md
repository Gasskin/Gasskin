---
title: "ECSCombat03 行动机制"
tags: 战斗
---

对一次普工进行拆分，分为如下阶段：

1. **普攻行动能力 AttackActionAbility** 是否可以普攻（或者进行其他操作）
2. **普攻行动 AttackAction** 普攻能力中转类
3. **普攻能力 AttackAbility** 能力是初始化时就确定的，比如不同的英雄，初始化时就会创建不同的普攻能力

4. **普攻能力执行 AttackAbilityExecution** 和普攻能力关联，具体的逻辑类

# IActionAbility

行动能力，比较简单

- **TryMakeAction** 尝试获取一个行动

```c#
public interface IActionAbility
{
    public bool TryMakeAction(GameEntity owner,out IActionExecution actionExecution);
}
```

# IActionExecution

行动，一个中间类，用于触发各种能力

```c#
public interface IActionExecution
{
    /// 行为对象
    public GameEntity Creator { get; set; }
    /// 行为目标
    public GameEntity Target { get; set; }
}
```

# AttackActionAbilityComponent

普攻行为能力组件

```c#
[Game]
public class AttackActionAbilityComponent : IComponent
{
    public AttackActionAbility attackActionAbility;
}
```

具体的逻辑类

**普攻行为能力**

```c#
public class AttackActionAbility : IActionAbility
{    
    public bool TryMakeAction(GameEntity owner,out IActionExecution actionExecution)
    {
        // 这里可以进行各种条件判断，比如是否在CD中
        actionExecution = new AttackActionExecution();
        return true;
    }
}
```

**普攻行为**

```c#
public class AttackActionExecution : IActionExecution
{
    public GameEntity Creator { get; set; }
    public GameEntity Target { get; set; }

    public void ApplyAttack()
    {
        // todo
    }
}
```

添加一个普攻行为能力就很简单了

```c#
player = Contexts.sharedInstance.game.CreateEntity();
player.AddAttackActionAbility(new AttackActionAbility());
```

# IAbility

能力，诸如移动，普攻，释放技能，都可以当做一种行动（应该作为XXActionAbilityComponent）

而每一种行为，肯定需要一种具体的能力，普攻行为肯定需要普攻能力

普攻能力，每一个玩家，可能是不同的，所以也抽象成一种组件

```c#
public interface IAbility 
{
    /// 创建能力执行体
    public IAbilityExecution CreateExecution(GameEntity owner);
}
```

**普攻能力实现类**

# BaseAbilityExecution

能力执行，每一种能力具体的逻辑放在这儿，行为逻辑需要Update，所以我们需要分阶段

```c#
public enum AbilityExecutionProcess
{
    None,
    Begin,
    End,
}
```

```c#
public abstract class BaseAbilityExecution
{
    private AbilityExecutionProcess process = AbilityExecutionProcess.None;
    
    public void Update()
    {
        switch (process)
        {
            case AbilityExecutionProcess.None:
                break;
            case AbilityExecutionProcess.Begin:
                if (!Execute())
                    process = AbilityExecutionProcess.End;
                break;
            case AbilityExecutionProcess.End:
                EndExecute();
                break;
        }
    }

    /// 开始执行
    public virtual void BeginExecute()
    {
        process = AbilityExecutionProcess.Begin;
    }
    
    // 执行中
    public virtual bool Execute()
    {
        return false;
    }
     
    /// 结束执行
    public virtual void EndExecute()
    {
        
    }
}
```

# AttackActionExecution

行动执行类，行动执行类，近为这一次行动做各种的信息整合，并不处理具体的逻辑，具体的逻辑，应该交给具体的能力类













